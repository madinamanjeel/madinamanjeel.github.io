<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirilis Ertugrul - API Version with Subtitles</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for easy theme management */
        :root {
            --background-tex: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            --primary-bg: #1a1a1a;
            --container-bg: #2d2d2d;
            --accent-gold: #c5a47e;
            --accent-gold-hover: #e0bb95;
            --text-light: #f5f5f5;
            --text-dark: #333;
            --border-color: #444;
            --font-title: 'Cinzel', serif;
            --font-body: 'Lora', serif;
        }

        body {
            font-family: var(--font-body);
            margin: 0;
            padding: 0;
            background-color: var(--primary-bg);
            background-image: var(--background-tex);
            color: var(--text-light);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #222;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold-hover);
        }

        .playlist {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .sticky-top-section {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--container-bg);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        
        .series-banner img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 2px solid var(--accent-gold);
        }

        .playlist h2 {
            font-family: var(--font-title);
            text-align: center;
            font-size: 1.7em;
            margin: 0;
            padding: 20px 0;
            color: var(--accent-gold);
            text-shadow: 0 0 10px rgba(197, 164, 126, 0.5);
            letter-spacing: 2px;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .sticky-player {
            padding: 10px;
        }

        video { /* Changed from iframe to video */
            display: block;
            width: 100%;
            aspect-ratio: 16 / 9;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: #000;
        }

        .video-title {
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            padding: 15px;
            color: var(--text-light);
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border-color);
        }

        #video-list {
            list-style: none;
            padding: 15px 20px;
            margin: 0;
        }

        .video-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 8px;
            background: transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            border: 1px solid var(--border-color);
        }
        
        .video-item:hover {
            background-color: rgba(197, 164, 126, 0.1);
            transform: translateX(5px);
            box-shadow: 0 0 15px var(--accent-gold), 0 0 25px var(--accent-gold-hover);
            border-color: var(--accent-gold);
        }
        
        .video-name {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-light);
        }
        
        /* Season Dropdown Styling (hidden as per previous request) */
        .season-select {
            display: none; 
        }
        
        /* For mobile devices */
        @media (max-width: 768px) {
            .playlist {
                max-width: 100%; 
            }
            .series-banner img {
                height: 120px;
            }
            .playlist h2 {
                font-size: 1.5em; 
                white-space: normal; 
            }
            .sticky-player {
                padding: 5px; 
            }
            .video-item {
                padding: 12px;
            }
        }

    </style>
</head>
<body>
    <div class="playlist">
        <div class="sticky-top-section">
            
            <h2>INTERNATIONAL MOVIES</h2>
            
            <div class="sticky-player">
                <video id="player" controls crossorigin="anonymous"></video> 
            </div>
            <div class="video-title" id="current-video-title">Loading videos...</div>

            <div class="season-select">
                <button class="season-button" onclick="toggleSeasonDropdown()">
                    <span>Select Season</span>
                </button>
               
                <div id="seasonDropdown" class="season-dropdown">
                    <a href="ertugrul1.html">Season 1</a>
                    <a href="ertugrul2.html">Season 2</a>
                    <a href="ertugrul3.html">Season 3</a>
                    <a href="ertugrul4.html">Season 4</a>
                    <a href="ertugrul5.html">Season 5</a>
                </div>

            </div>
        </div>

        <ul id="video-list">
            </ul>
    </div>

    <script>
        // YOUR PROVIDED GOOGLE DRIVE FOLDER ID AND API KEY
        const FOLDER_ID = "10Q-XhUtX1Oj7FsCHJXuB1hZ118VIDD36"; // Updated Google Drive Folder ID
        const API_KEY = "AIzaSyBK2E3irCautj-id8ke1tmVBElXYf0aHdU"; // Your Google Drive API Key

        let videos = []; // Stores video file metadata { id, name }
        let subtitlesMap = {}; // Stores subtitle file IDs mapped by video name (e.g., {'VideoName': 'subtitleId'})
        let currentIndex = 0;

        /**
         * Fetches video and subtitle files from the specified Google Drive folder.
         * Files must be publicly accessible ("Anyone with the link").
         */
        async function fetchFilesFromDrive() {
            // Query for both MP4 videos and SRT subtitle files
            const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+(mimeType='video/mp4' or mimeType='application/x-subrip')&key=${API_KEY}&fields=files(id,name,mimeType)&orderBy=name&pageSize=1000`; // Increased pageSize for more files

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }
                const data = await response.json();

                if (data.files && data.files.length > 0) {
                    videos = []; // Clear previous videos
                    subtitlesMap = {}; // Clear previous subtitles

                    data.files.forEach(file => {
                        if (file.mimeType === 'video/mp4') {
                            videos.push(file);
                        } else if (file.mimeType === 'application/x-subrip' && file.name.endsWith('.srt')) {
                            // Map subtitle to video by stripping .srt extension
                            // Example: 'MyVideo.srt' maps to 'MyVideo'
                            const videoNameWithoutExt = file.name.replace(/\.srt$/, '');
                            subtitlesMap[videoNameWithoutExt] = file.id;
                        }
                    });

                    // Sort videos by name to ensure consistent order
                    videos.sort((a, b) => a.name.localeCompare(b.name));

                    displayVideoList(); // Update the UI with the fetched videos
                    
                    if (videos.length > 0) {
                        playVideo(0); // Play the first video by default
                    } else {
                        document.getElementById('current-video-title').textContent = "No videos found.";
                        document.getElementById('video-list').innerHTML = "<p style='text-align: center; padding: 20px;'>No videos found in this folder. Make sure files are publicly accessible.</p>";
                    }
                } else {
                    console.warn("No files found in the specified folder or API returned empty.");
                    document.getElementById('current-video-title').textContent = "No videos found.";
                    document.getElementById('video-list').innerHTML = "<p style='text-align: center; padding: 20px;'>No videos found in this folder. Double-check Folder ID and API Key, and ensure files are publicly accessible ('Anyone with the link').</p>";
                }
            } catch (error) {
                console.error("Error fetching files from Google Drive API:", error);
                document.getElementById('current-video-title').textContent = "Error loading videos.";
                document.getElementById('video-list').innerHTML = `<p style='text-align: center; padding: 20px; color: red;'>Failed to load videos: ${error.message}. Check console for details.</p>`;
            }
        }

        /**
         * Populates the video list UI elements.
         */
        function displayVideoList() {
            const videoList = document.getElementById('video-list');
            videoList.innerHTML = ''; 

            videos.forEach((file, index) => {
                const videoItem = document.createElement('li');
                videoItem.className = 'video-item';
                videoItem.innerHTML = `<span class="video-name">${file.name.replace('.mp4', '')}</span>`;
                videoItem.onclick = () => playVideo(index);
                videoList.appendChild(videoItem);
            });
        }

        /**
         * Plays a selected video and attempts to load its corresponding subtitle.
         * @param {number} index - The index of the video in the `videos` array.
         */
        function playVideo(index) {
            if (videos[index]) {
                const videoPlayer = document.getElementById('player');
                const videoTitle = document.getElementById('current-video-title');
                currentIndex = index;

                const videoFile = videos[index];
                // Get video name without .mp4 extension for subtitle mapping
                const videoNameWithoutExt = videoFile.name.replace(/\.mp4$/, '');
                
                // Construct the direct media URL for the video using alt=media
                // WARNING: This URL is prone to CORS issues from Google Drive
                const videoSrc = `https://www.googleapis.com/drive/v3/files/${videoFile.id}?alt=media&key=${API_KEY}`;
                
                videoPlayer.src = videoSrc;
                videoTitle.textContent = videoNameWithoutExt;

                // Remove existing track elements to avoid duplicates
                // This ensures only the current video's subtitle is loaded
                Array.from(videoPlayer.querySelectorAll('track')).forEach(track => track.remove());

                // Attempt to add subtitle track if found
                const subtitleId = subtitlesMap[videoNameWithoutExt];
                if (subtitleId) {
                    // Construct the direct media URL for the subtitle
                    // WARNING: This URL is also prone to CORS issues
                    const subtitleSrc = `https://www.googleapis.com/drive/v3/files/${subtitleId}?alt=media&key=${API_KEY}`;
                    
                    const track = document.createElement('track');
                    track.kind = 'subtitles';
                    track.label = 'Bangla'; // You can change this label (e.g., 'English', 'Español')
                    track.srclang = 'bn';   // Change language code if needed (e.g., 'en', 'es')
                    track.src = subtitleSrc;
                    track.default = true; // Set this subtitle as the default one to be shown
                    videoPlayer.appendChild(track);
                    console.log(`Subtitle track added for: ${videoNameWithoutExt}, SRC: ${subtitleSrc}`);
                } else {
                    console.log(`No subtitle (.srt) found for: ${videoNameWithoutExt}`);
                }

                videoPlayer.load(); // Reload the video element to apply new src and tracks
                videoPlayer.play().catch(error => {
                    console.error("Autoplay failed:", error);
                    videoTitle.textContent = `Playing: ${videoNameWithoutExt} (Autoplay blocked, click play)`;
                    // If autoplay fails (common in browsers), prompt the user to click play
                });

                // Set up event listener for when the current video ends
                videoPlayer.onended = () => {
                    if (currentIndex + 1 < videos.length) {
                        playVideo(currentIndex + 1); // Play the next video in the list
                    } else {
                        console.log("Playlist ended.");
                        videoTitle.textContent = `Playlist ended. Last played: ${videoNameWithoutExt}`;
                    }
                };
            } else {
                console.error("Attempted to play a video at an invalid index:", index);
            }
        }

        // Initialize the application by fetching files from Google Drive
        fetchFilesFromDrive();

        // This function is no longer needed as the season-select div is hidden via CSS
        // function toggleSeasonDropdown() {
        //     const dropdown = document.getElementById('seasonDropdown');
        //     dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        // }
    </script>
</body>
</html>
