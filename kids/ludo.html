<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶∏‡ßç‡¶®‡ßá‡¶ï ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞! üêç</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Da+2:wght@400;700&family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4CAF50; --secondary: #8BC34A; --dark: #2F2F2F; --danger: #f44336; }
        body { font-family: 'Baloo Da 2', sans-serif; margin: 0; background: #e8f5e9; color: var(--dark); overflow-x: hidden; text-align: center; }
        
        #loading-message { padding-top: 100px; font-size: 1.5rem; font-weight: bold; }
        #content-wrapper { display: none; padding: 15px; }

        .game-header { background: var(--primary); color: white; padding: 15px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        canvas { background: #000; display: block; margin: 0 auto; border: 5px solid #333; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); touch-action: none; width: 100%; max-width: 400px; }

        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 200px; margin: 20px auto; }
        .btn { background: white; border: 2px solid var(--primary); padding: 15px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; user-select: none; }
        .btn:active { background: var(--primary); color: white; }
        .up { grid-column: 2; } .left { grid-column: 1; } .right { grid-column: 3; } .down { grid-column: 2; }

        .leaderboard { background: white; border-radius: 15px; padding: 15px; margin-top: 20px; border: 3px solid var(--primary); max-width: 400px; margin-left: auto; margin-right: auto; }
        .leaderboard-list { list-style: none; padding: 0; }
        .leaderboard-list li { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .leaderboard-list li img { width: 25px; height: 25px; border-radius: 50%; margin-right: 10px; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:30px; border-radius:20px; width:80%; max-width:300px; }
    </style>
</head>
<body>

    <div id="loading-message">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶π‡¶ö‡ßç‡¶õ‡ßá... üêç</div>

    <div id="content-wrapper">
        <div class="game-header">
            <h1 style="margin:0">üêç ‡¶∏‡ßç‡¶®‡ßá‡¶ï ‡¶ó‡ßá‡¶Æ</h1>
            <p style="margin:5px 0 0">‡¶∏‡ßç‡¶ï‡ßã‡¶∞: <span id="currentScore">0</span></p>
        </div>

        <canvas id="snakeGame" width="400" height="400"></canvas>

        <div class="controls">
            <div class="btn up" onclick="changeDirection('UP')">‚¨ÜÔ∏è</div>
            <div class="btn left" onclick="changeDirection('LEFT')">‚¨ÖÔ∏è</div>
            <div class="btn right" onclick="changeDirection('RIGHT')">‚û°Ô∏è</div>
            <div class="btn down" onclick="changeDirection('DOWN')">‚¨áÔ∏è</div>
        </div>

        <div class="leaderboard">
            <h3>üèÜ ‡¶∏‡ßá‡¶∞‡¶æ ‡ß´ ‡¶ñ‡ßá‡¶≤‡ßã‡ßü‡¶æ‡ßú</h3>
            <ul id="scoreList" class="leaderboard-list"><li>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</li></ul>
        </div>
    </div>

    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--danger)">‡¶ó‡ßá‡¶Æ ‡¶ì‡¶≠‡¶æ‡¶∞!</h2>
            <p>‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ï‡ßã‡¶∞: <span id="finalScore">0</span></p>
            <button onclick="location.reload()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:10px;">‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ñ‡ßá‡¶≤‡ßã</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithRedirect } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® (‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
        const firebaseConfig = {
          apiKey: "AIzaSyAXZwWx1egnLtdgExUDepoLB6b20CrGwms",
          authDomain: "family-429c7.firebaseapp.com",
          databaseURL: "https://family-429c7-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "family-429c7",
          storageBucket: "family-429c7.firebasestorage.app",
          messagingSenderId: "982876086618",
          appId: "1:982876086618:web:97d56fd46148561cf2d363",
          measurementId: "G-2E0SPSS8TN"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        const allowedEmails = ["mashayekh.ahmed.archives@gmail.com", "mashayekh64@gmail.com", "shariatunnesa.madina@gmail.com", "abdulkhalequebaf@gmail.com", "lima.akter.1323@gmail.com", "lima.akter.0390@gmail.com", "ahmad.muttaqeen@gmail.com", "nusaiba.jannat.alifa@gmail.com", "afia.ahmed.adiba@gmail.com", "darulahmed467170@gmail.com", "madina.manjeel.tv@gmail.com"];

        onAuthStateChanged(auth, (user) => {
            if (user && allowedEmails.includes(user.email)) {
                currentUser = user;
                document.getElementById('loading-message').style.display = 'none';
                document.getElementById('content-wrapper').style.display = 'block';
                loadLeaderboard();
                gameLoop();
            } else if (user) {
                alert("‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!");
                window.location.href = "https://google.com";
            } else {
                signInWithRedirect(auth, provider);
            }
        });

        // --- ‡¶ó‡ßá‡¶Æ ‡¶≤‡¶ú‡¶ø‡¶ï ---
        const canvas = document.getElementById("snakeGame");
        const ctx = canvas.getContext("2d");
        const box = 20;
        let score = 0;
        let snake = [{x: 9 * box, y: 10 * box}];
        let food = { x: Math.floor(Math.random() * 19 + 1) * box, y: Math.floor(Math.random() * 19 + 1) * box };
        let d = "RIGHT";

        window.changeDirection = (dir) => {
            if(dir == "LEFT" && d != "RIGHT") d = "LEFT";
            else if(dir == "UP" && d != "DOWN") d = "UP";
            else if(dir == "RIGHT" && d != "LEFT") d = "RIGHT";
            else if(dir == "DOWN" && d != "UP") d = "DOWN";
        };

        document.addEventListener("keydown", (e) => {
            if(e.keyCode == 37 && d != "RIGHT") d = "LEFT";
            else if(e.keyCode == 38 && d != "DOWN") d = "UP";
            else if(e.keyCode == 39 && d != "LEFT") d = "RIGHT";
            else if(e.keyCode == 40 && d != "UP") d = "DOWN";
        });

        function draw() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for(let i = 0; i < snake.length; i++){
                ctx.fillStyle = (i == 0) ? "#4CAF50" : "#8BC34A";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
                ctx.strokeStyle = "black";
                ctx.strokeRect(snake[i].x, snake[i].y, box, box);
            }

            ctx.fillStyle = "red";
            ctx.fillRect(food.x, food.y, box, box);

            let snakeX = snake[0].x;
            let snakeY = snake[0].y;

            if( d == "LEFT") snakeX -= box;
            if( d == "UP") snakeY -= box;
            if( d == "RIGHT") snakeX += box;
            if( d == "DOWN") snakeY += box;

            if(snakeX == food.x && snakeY == food.y){
                score++;
                document.getElementById('currentScore').innerText = score;
                food = { x: Math.floor(Math.random() * 19 + 1) * box, y: Math.floor(Math.random() * 19 + 1) * box };
            } else {
                snake.pop();
            }

            let newHead = { x: snakeX, y: snakeY };

            if(snakeX < 0 || snakeX >= canvas.width || snakeY < 0 || snakeY >= canvas.height || collision(newHead, snake)){
                clearInterval(game);
                endGame();
            }

            snake.unshift(newHead);
        }

        function collision(head, array){
            for(let i = 0; i < array.length; i++){
                if(head.x == array[i].x && head.y == array[i].y) return true;
            }
            return false;
        }

        let game;
        function gameLoop() {
            game = setInterval(draw, 150);
        }

        async function endGame() {
            document.getElementById('finalScore').innerText = score;
            document.getElementById('gameOverModal').style.display = 'flex';
            
            if (currentUser) {
                const userRef = doc(db, "snake_scores", currentUser.uid);
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists() || score > docSnap.data().score) {
                    await setDoc(userRef, { name: currentUser.displayName, photo: currentUser.photoURL, score: score });
                }
            }
        }

        function loadLeaderboard() {
            const q = query(collection(db, "snake_scores"), orderBy("score", "desc"), limit(5));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('scoreList');
                list.innerHTML = "";
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    list.innerHTML += `<li><span><img src="${data.photo}"> ${data.name}</span> <b>${data.score}</b></li>`;
                });
            });
        }
    </script>
</body>
</html>
